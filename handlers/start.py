from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from utils.limits import limiter
from handlers.subscription import check_subscription, send_subscription_message
from config import Config
import time
import logging

logger = logging.getLogger(__name__)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø£ÙˆÙ„Ø§Ù‹
        if not await check_subscription(update, context):
            await send_subscription_message(update, context)
            return
        
        user_id = update.effective_user.id
        is_premium = limiter.is_premium_user(user_id)
        
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø¯ÙˆØ¯
        allowed, time_left, char_limit = limiter.check_limits(user_id)
        user_data = limiter.db.get_user(user_id)
        
        # Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
        current_time = time.time()
        reset_time = user_data.get('reset_time', current_time + (Config.PREMIUM_RESET_HOURS * 3600 if is_premium else Config.RESET_HOURS * 3600))
        time_left = max(0, reset_time - current_time)
        hours_left = max(0, int(time_left // 3600))
        
        # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ù„Ù„Ø¹Ø±Ø¶
        if is_premium:
            request_limit = Config.PREMIUM_REQUEST_LIMIT
            remaining_uses = request_limit - user_data.get('request_count', 0)
            limit_msg = f"ğŸŒŸ (Ø­Ø³Ø§Ø¨ Ù…Ù…ÙŠØ²) Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: {remaining_uses}/{request_limit}"
            char_msg = f"ğŸ“ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù†Øµ: {Config.PREMIUM_CHAR_LIMIT} Ø­Ø±ÙØ§Ù‹"
        else:
            request_limit = Config.REQUEST_LIMIT
            remaining_uses = request_limit - user_data.get('request_count', 0)
            limit_msg = f"ğŸ“Š Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: {remaining_uses}/{request_limit}"
            char_msg = f"ğŸ“ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù†Øµ: {Config.CHAR_LIMIT} Ø­Ø±ÙØ§Ù‹"

        # Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
        welcome_msg = (
            "âœ¨ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù†Ø­ÙˆÙŠ âœ¨\n\n"
            f"{limit_msg}\n"
            f"â³ ÙˆÙ‚Øª Ø§Ù„ØªØ¬Ø¯ÙŠØ¯: Ø¨Ø¹Ø¯ {hours_left} Ø³Ø§Ø¹Ø©\n"
            f"{char_msg}\n\n"
            "ğŸ¯ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:\n"
            "- ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù†Ø­ÙˆÙŠØ© ÙˆØ§Ù„Ø¥Ù…Ù„Ø§Ø¦ÙŠØ©\n"
            "- Ø¥Ø¹Ø§Ø¯Ø© ØµÙŠØ§ØºØ© Ø§Ù„Ù†ØµÙˆØµ Ø¨Ø§Ø­ØªØ±Ø§ÙÙŠØ©\n\n"
            "ğŸ’¡ Ù„ØªÙØ¹ÙŠÙ„ API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰:\n"
            f"- {Config.PREMIUM_REQUEST_LIMIT} Ø·Ù„Ø¨ ÙŠÙˆÙ…ÙŠØ§Ù‹\n"
            f"- Ø­Ø¯ {Config.PREMIUM_CHAR_LIMIT} Ø­Ø±ÙØ§Ù‹ Ù„Ù„Ù†Øµ\n"
            "Ø£Ø±Ø³Ù„: /setapi <api_key>"
        )
        
        # Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ Ø¥Ù† Ø£Ø±Ø¯Øª
        keyboard = [
            [InlineKeyboardButton("ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…", callback_data="start_using")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await update.message.reply_text(welcome_msg, reply_markup=reply_markup)

    except Exception as e:
        logger.error(f"Error in start command: {str(e)}", exc_info=True)
        await update.message.reply_text("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.")

async def handle_start_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        query = update.callback_query
        await query.answer()
        await query.edit_message_text("ğŸ“ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡:")
    except Exception as e:
        logger.error(f"Error in start button: {str(e)}")
        await query.edit_message_text("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©.")
